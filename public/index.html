<!doctype html> 
<html lang="en"> 
<head> 
  <meta charset="UTF-8" />
  <title>Web Socket Pong</title>
  <script type="text/javascript" src="js/phaser.min.js"></script>
  <script type="text/javascript" src="js/constants.js"></script>
  <script type="text/javascript" src="/socket.io/socket.io.js"></script>
  <style type="text/css">
    body {
      margin: 0;
    }
  </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });


function preload() {

}

var paddles = [];
var scoreText;
var cursors;
var socket;

var clientID;
var ready = false;

function createPaddle(x) {
  paddle = game.add.graphics(x, constants.PADDLE_START_Y);
  paddle.beginFill(0x00ff00, 1);
  paddle.drawRect(0, 0, constants.PADDLE_WIDTH, constants.PADDLE_HEIGHT);

  return paddle;
}

function create() {   
  socket = io.connect('http://localhost');

  socket.on('assignID', function(data) {
    console.log('Assigned ID: ' + data);
    clientID = data;    
  });

  socket.on('ready', function(data) {
    ready = true;
    console.log("Two players connected. Game is ready!");
  });

  paddles[0] = createPaddle(50);
  paddles[1] = createPaddle(game.width - 50 - constants.PADDLE_WIDTH);

  //  Our controls.
  cursors = game.input.keyboard.createCursorKeys();
}

var moveDirection = constants.DirectionEnum.IDLE;
var moveStart;
var moveDestination;

function movePaddle(paddle, distance, direction, destination) {
  if (direction == constants.DirectionEnum.IDLE) {
    throw "direction cannot be IDLE in movePaddle()!";
  }

  // If we're already there, change the state to indicate we are no longer
  // moving.
  if (paddle.y == destination) {
    moveDirection = constants.DirectionEnum.IDLE;
    return;
  }
  if (direction == constants.DirectionEnum.UP) {
    paddle.y -= distance;
  }
  else if (direction == constants.DirectionEnum.DOWN) {
    paddle.y += distance;
  }

  // Check bounds. If we're trying to move past where we're supposed to, stop
  // moving.
  if (paddle.y < 0) {
    paddle.y = 0;
    moveDirection = constants.DirectionEnum.IDLE;
  }
  else if (paddle.y + constants.PADDLE_HEIGHT > game.height) {
    paddle.y = game.height - constants.PADDLE_HEIGHT;
    moveDirection = constants.DirectionEnum.IDLE;
  }
}

function update() {
  if (!ready)
    return;

  console.log(moveDirection);
  // If we are not moving the player's paddle
  if (moveDirection == constants.DirectionEnum.IDLE) {
    
    moveStart = paddles[clientID].y;
    if (cursors.up.isDown) {
      moveDirection = constants.DirectionEnum.UP;
      moveDestination = moveStart - constants.MOVE_DISTANCE;
      movePaddle(paddles[clientID], constants.DISTANCE_PER_FRAME, constants.DirectionEnum.UP, moveDestination);
    }
    else if(cursors.down.isDown) {
      moveDirection = constants.DirectionEnum.DOWN;
      moveDestination = moveStart + constants.MOVE_DISTANCE;
      movePaddle(paddles[clientID], constants.DISTANCE_PER_FRAME, constants.DirectionEnum.DOWN, moveDestination);
    }

    //socket.emit('move', {'position': paddles[0].y, 'direction': moveDirection});
  }
  // If we are in the process of moving the player's paddle
  else {
    movePaddle(paddles[clientID], constants.DISTANCE_PER_FRAME, moveDirection, moveDestination);
  }
}

</script>

</body>
</html>
